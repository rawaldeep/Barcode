<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZXing for JS">
    <title>Barcode Reader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://unpkg.com/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/milligram">
    <audio id="beepSound" src="assets/sounds/beep.mp3" preload="auto"></audio>
</head>
<body>
<div class="container" style="padding-top: 2em;">
    <button class="btn btn-primary" id="openScannerButton">Start Scanner</button>
    <div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scanner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <video id="video" width="100%" height="auto" style="border: 1px solid gray"></video>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form for adding products -->
    <div class="add-product-form">
        <h4>Add a Product</h4>
        <form id="productForm">
            <input type="text" id="productName" placeholder="Product Name" required />
            <input type="text" id="productPrice" placeholder="Price" required />
            <input type="text" id="productBarcode" placeholder="Barcode" required />
            <button type="submit" class="btn btn-info">Add Product</button>
        </form>
    </div>

    <label>Result:</label>
    <pre><code id="result"></code></pre>
    <div id="errorMessage" class="alert alert-danger" style="display:none;"></div>
    <h4>Scan History:</h4>
    <ul id="scanHistory"></ul>
    <h4>Logs:</h4>
    <pre><code id="logs"></code></pre>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script>
let products = [];
function fetchProducts() {
    return fetch('products.json')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        products = data;
        log('Products loaded:', products);
    })
    .catch(error => {
        console.error('Failed to load products:', error);
    });
}

function log(...messages) {
    const logsElement = document.getElementById('logs');
    messages.forEach((message) => {
        let messageToDisplay = '';
        if (typeof message === 'object') {
            messageToDisplay = JSON.stringify(message, null, 2);
        } else {
            messageToDisplay = message.toString();
        }
        logsElement.textContent += messageToDisplay + '\n';
    });
    logsElement.scrollTop = logsElement.scrollHeight;
    console.log(...messages);
}

$(document).ready(function () {
    fetchProducts();
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const beepSound = document.getElementById('beepSound');
    const logsElement = document.getElementById('logs');
    $('#openScannerButton').click(async function () {
    try {
            // Trigger camera permission dialog
            await navigator.mediaDevices.getUserMedia({ video: true });

            // List video input devices
            const videoInputDevices = await codeReader.listVideoInputDevices();
            const rearCameraDevice = videoInputDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear'));
            
            const selectedDeviceId = rearCameraDevice ? rearCameraDevice.deviceId : videoInputDevices[0]?.deviceId;

            $('#scannerModal').modal('show');

            const constraints = {
                video: {
                    deviceId: { exact: selectedDeviceId },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };

            codeReader.decodeFromConstraints(constraints, 'video', (result, err) => {
                if (result) {

                    log('Barcode scanned: ' + result.text);
                    /*document.getElementById('result').textContent = result.text;*/
                    
                    const product = products.find(p => p.barcode == result.text);

                    if (product) {
                        document.getElementById('result').textContent = `Name: ${product.name}, Price: ${product.price}`;
                        alert(`Name: ${product.name}, Price: ${product.price}`);
                    } else {
                            log(`No product found for scanned barcode: ${result.text}`);
                            document.getElementById('result').textContent = "Product not found for barcode: " + result.text;
                    }
                    document.getElementById('scanHistory').innerHTML += `<li>${result.text}</li>`;
                    beepSound.play();
                    $('#scannerModal').modal('hide'); // This line closes the modal
                    codeReader.reset();
                } else if (err && !(err instanceof ZXing.NotFoundException)) {
                    log('Error scanning barcode: ' + err);
                }
            });
        } catch (error) {
            log('Error initializing camera or scanner: ' + error);
        }
    });

    $('#scannerModal').on('hidden.bs.modal', function () {
        codeReader.reset();
        document.getElementById('result').textContent = '';
    });

    // Form submission handler for adding new products
    $('#productForm').on('submit', function(event) {
        event.preventDefault();
        const newProduct = {
            name: $('#productName').val(),
            price: $('#productPrice').val(),
            barcode: $('#productBarcode').val()
        };
        products.push(newProduct);
        $('#productName').val('');
        $('#productPrice').val('');
        $('#productBarcode').val('');
        log('New product added:', newProduct);
    });
});
</script>
</body>
</html>